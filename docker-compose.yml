version: '3.8'
services:
    db:
      container_name: postgres
      image: folent/nodejs2022q4-service-postgres
      build:
        context: ./src/db
      restart: on-failure
      environment:
        - POSTGRES_USER=${POSTGRES_USER}
        - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
        - POSTGRES_DB=${POSTGRES_DB}
      logging:
        options:
          max-size: 10m
          max-file: "3"
      ports:
        - ${POSTGRES_PORT}:${POSTGRES_PORT}
      networks:
      - home
    backend:
      container_name: backend-nest
      image: folent/nodejs2022q4-service-nest
      build: 
        context: ./
      depends_on:
        - db
      restart: on-failure
      ports:
        - ${PORT}:${PORT}
      environment:
        - POSTGRES_HOST=db
        - POSTGRES_PORT=${POSTGRES_PORT}
        - POSTGRES_USER=${POSTGRES_USER}
        - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
        - POSTGRES_DB=${POSTGRES_DB}
      networks:
      - home

networks:
  home: