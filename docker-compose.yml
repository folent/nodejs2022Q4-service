version: '3.8'
services:
    db:
      container_name: postgres
      image: folent/nodejs2022q4-service-postgres
      build:
        context: ./src/db
      restart: on-failure
      environment:
        - POSTGRES_USER=${POSTGRES_USER}
        - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
        - POSTGRES_DB=${POSTGRES_DB}
      logging:
        options:
          max-size: 10m
          max-file: "3"
      ports:
        - ${POSTGRES_PORT}:${POSTGRES_PORT}
      networks:
        - home
      volumes:
        - pgdata:/var/lib/postgresql/data
    backend:
      container_name: backend-nest
      image: folent/nodejs2022q4-service-nest
      build: 
        context: ./
      depends_on:
        - db
      restart: on-failure
      ports:
        - ${PORT}:${PORT}
      environment:
        - POSTGRES_HOST=db
        - POSTGRES_PORT=${POSTGRES_PORT}
        - POSTGRES_USER=${POSTGRES_USER}
        - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
        - POSTGRES_DB=${POSTGRES_DB}
        - CRYPT_SALT=${CRYPT_SALT}
        - JWT_SECRET_KEY=${JWT_SECRET_KEY}
        - JWT_SECRET_REFRESH_KEY=${JWT_SECRET_REFRESH_KEY}
        - TOKEN_EXPIRE_TIME=${TOKEN_EXPIRE_TIME}
        - TOKEN_REFRESH_EXPIRE_TIME=${TOKEN_REFRESH_EXPIRE_TIME}
        - MAX_LOG_LEVEL=${MAX_LOG_LEVEL}
        - MAX_LOG_FILE_IN_KB=${MAX_LOG_FILE_IN_KB}
      networks:
      - home

networks:
  home:

volumes:
  pgdata: